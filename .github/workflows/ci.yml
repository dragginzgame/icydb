name: CI
on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      CARGO_TERM_COLOR: always
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.93.0
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          # Restrict cache scanning to the real workspace root.
          # trybuild generates temporary Cargo.toml files under target/tests,
          # and scanning those can make the cache action probe missing paths
          # like target/tests/target in post-job cleanup.
          workspaces: |
            . -> target
      - run: bash scripts/ci/validate-workflow-packages.sh .github/workflows/ci.yml
      - run: bash scripts/ci/check-index-range-spec-invariants.sh
      - run: cargo fmt --all -- --check
      - run: cargo clippy --workspace --all-targets -- -D warnings
      - run: cargo test --workspace --all-targets --verbose

  release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: check
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.93.0
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
      - run: cargo build --workspace --target wasm32-unknown-unknown --release
      - run: |
          mkdir -p artifacts
          target_dir="$(cargo metadata --format-version=1 --no-deps \
            | python3 -c 'import json,sys; print(json.load(sys.stdin)["target_directory"])')"
          wasm_dir="${target_dir}/wasm32-unknown-unknown/release"
          mapfile -t wasms < <(find "$wasm_dir" -maxdepth 1 -type f -name '*.wasm' | sort)

          if [ "${#wasms[@]}" -eq 0 ]; then
            echo "No wasm artifacts found in workspace release build."
            exit 0
          fi

          cp "${wasms[@]}" artifacts/

          cargo install candid-extractor --locked
          for wasm in "${wasms[@]}"; do
            base="$(basename "$wasm" .wasm)"
            did="artifacts/${base}.did"
            if candid-extractor "$wasm" > "$did"; then
              echo "Extracted $did"
            else
              echo "Skipping candid extraction for $wasm (no candid service metadata)."
              rm -f "$did"
            fi
          done
      - uses: actions/upload-artifact@v4
        with:
          name: wasm-artifacts
          path: artifacts/*
          if-no-files-found: warn
