# 0.29 Status (as of 2026-02-25)

## 0.29 Scope

This status tracks pre-`0.31 GROUP BY` hardening from:

- `docs/design/0.29-hardening-before-group-by.md`

`0.29` is structural only. `0.29.0` established the baseline; `0.29.8` applies focused `db/` audit hardening.

---

## Patchline Split (`0.29.8` vs `0.30+`)

- `0.29.8` is for surgical hardening with low behavior risk and high drift reduction.
- Structural execution/routing rework from the `db/` audit is moved to `0.30` (`docs/design/0.30-execution-kernel.md`).
- `0.29.9+` is reserved for release-line hardening only if needed.
- Historical `0.29.0` baseline sections remain below for traceability.

## In Scope (`0.29.8`)

- unify residual underfill/retry flow so aggregate and load paths share one canonical retry boundary
- remove query/index layering leaks in cursor/query contracts (`db/query/contracts` must not depend on `db/index`)
- normalize commit marker corruption signaling to one explicit constructor/classification shape
- add explicit route/execution parity tests for `ConservativeSubset` vs `StrictAllOrNone` boundaries

## Out of Scope (`0.29.8`)

- route planner module decomposition and aggregate module decomposition
- true pull-based streaming conversion (removing eager key-vector materialization)
- `O(n^2)` projection/terminal path reshaping
- broad aggregate/load/count-distinct pipeline convergence beyond surgical dedupe
- new terminals, new aggregate families, new routing modes, `GROUP BY`

---

## Locked Baselines (`0.29`)

- [x] Error taxonomy baseline re-validated (null/missing parity + fail-before-scan unchanged)
- [x] Determinism baseline re-validated (pk tie-break + comparator contracts unchanged)
- [x] Continuation baseline re-validated (ranked terminals remain non-paged; no cursor expansion)

---

## Release Snapshot (`0.29.8`)

- [ ] `0.29.8` released
- [x] Underfill/retry logic is canonicalized across load + aggregate distinct paths
- [x] Query/index layer boundaries restored in cursor/query contracts
- [x] Commit marker corruption errors use one explicit constructor/classification path
- [x] `ConservativeSubset` vs `StrictAllOrNone` route/execute parity tests are merged and green
- [x] DISTINCT wrapping duplication removed through one shared executor entrypoint
- [x] `count_distinct_by` value dedupe changed from quadratic scan behavior to set-based canonical dedupe
- [x] Changelog entry added for `0.29.8`

Current `0.29.8` status: **code complete, pending release/tag**.

### `0.29.8` Focused Work Items (from `db/` audit)

1. Canonicalize residual retry flow duplication:
   - `crates/icydb-core/src/db/executor/load/mod.rs`
   - `crates/icydb-core/src/db/executor/load/aggregate/distinct.rs`
2. Fix query/index layering leak:
   - `crates/icydb-core/src/db/query/contracts/cursor.rs`
   - `crates/icydb-core/src/db/query/plan/mod.rs`
3. Normalize commit marker error construction/classification:
   - `crates/icydb-core/src/db/commit/store.rs`
   - `crates/icydb-core/src/db/commit/mod.rs`
4. Add explicit routing precedence parity coverage:
   - `crates/icydb-core/src/db/executor/load/execute.rs`
   - `crates/icydb-core/src/db/executor/route/planner.rs`
5. Remove DISTINCT wrapping duplication and keep one wrapper boundary:
   - `crates/icydb-core/src/db/executor/load/execute.rs`
   - `crates/icydb-core/src/db/executor/load/aggregate/mod.rs`
   - `crates/icydb-core/src/db/executor/load/aggregate/distinct.rs`
6. Replace quadratic value dedupe in `count_distinct_by` without semantic change:
   - `crates/icydb-core/src/db/executor/load/aggregate/distinct.rs`

## Deferred to `0.30` (Execution Kernel Consolidation)

- split oversized route planner and aggregate executor modules to reduce coupling and branch density
- convert key-stream path from eager key vectors to pull-based streaming contracts
- remove remaining parallel load/aggregate/count-distinct execution orchestration paths
- centralize reducer ownership under one execution kernel contract

---

## Historical Snapshot (`0.29.0`)

## Release Snapshot (`0.29.0`)

- [ ] `0.29.0` released
- [x] Design doc created (`docs/design/0.29-hardening-before-group-by.md`)
- [x] Milestone hardening tracker finalized
- [x] Canonical aggregate fast-path eligibility gate implemented
- [x] Mandatory callsite enforcement added for aggregate fast paths
- [x] Aggregate fast-path eligibility is compiler-enforced where feasible (verified marker/token pattern)
- [x] Ranked comparator logic fully routed through canonical ranked-row helpers
- [x] Central execution-mode selector is explicit and authoritative for aggregate terminals
- [x] Implicit fold-internal mode fallback paths removed or guarded
- [x] Execution mode is fixed pre-fold-allocation and immutable for execution lifetime
- [x] Materialized-only grouped-fold readiness contract is documented and test-locked pre-`0.31`
- [x] Cursor terminal-shape signature lock tests added
- [x] Cursor signature binding covers ordering spec, direction, and limit/window shape
- [x] HashMap iteration determinism audit completed with ordering notes
- [x] Order-irrelevant iteration paths are explicitly documented to prevent accidental coupling
- [x] Forced access-shape ranking invariance matrix completed (`FullScan` + `IndexRange`, ASC/DESC)
- [x] Randomized insertion-order determinism test added for ranked output invariance
- [x] Commit/replay failure-injection parity matrix expanded
- [x] Mixed-state failure injection covered (`index success`, `row failure`, rollback, no visible inconsistency)
- [x] Replay-apply failure injection edge covered with no-half-state assertion
- [x] Duplicate enforcement branches consolidated without behavior change
- [x] Redundant slot-resolution checks consolidated without behavior change
- [x] Aggregate planner descriptor/spec boundaries consolidated for grouped-readiness
- [x] Aggregate spec unification completed as all-or-nothing (no partial-dispatch hybrid)
- [x] Execution layer consumes unified internal aggregate spec only (early terminal-to-spec translation)
- [x] Fold-state container boundary supports grouped multi-state shape (internal-only, no behavior change)
- [x] Memory-pressure/scan-budget/underfill contract audit completed for grouped-readiness
- [x] Ranking-terminal memory semantics documented (materialization dependency + growth bound)
- [x] Fold-state lifetime and row-reference retention boundaries documented
- [x] Early top-k optimization explicitly deferred (no heap-streaming top-k path in `0.29`)
- [x] Changelog entry added for `0.29.0`

Current `0.29.0` status: **baseline hardening complete**.

Current first execution focus:

- Phase 5 complete; final 0.29 pre-release validation and baseline check closeout.

---

## Phase Tracker

## Phase 1 - Aggregate Surface Hardening

- [x] Fast-path eligibility centralization complete
- [x] Eligibility bypass-prevention tests complete
- [x] Eligibility entrypoint shape is mechanically enforced (verified marker/token or equivalent)
- [x] Ranked helper enforcement complete
- [x] Query-shape to execution-mode boundary hardening complete
- [x] Execution mode immutability (pre-fold-allocation + no mid-run mutation) enforced
- [x] Cursor signature lockdown tests complete
- [x] Cursor signature bindings include ordering/direction/window-shape invariants

## Phase 2 - Determinism Audit

- [x] HashMap iteration-order semantic audit complete
- [x] Ordering relevance comments/assertions added at critical boundaries
- [x] Order-irrelevant paths documented to avoid accidental BTree/Hash ordering coupling
- [x] Global comparator invariance tests complete
- [x] Randomized insertion-order ranked-output invariance test complete

## Phase 3 - Commit and Recovery Hardening

- [x] Replay parity expansion complete
- [x] Failure-injection no-half-state coverage complete
- [x] Mixed-state failure edge coverage complete (`index success` + `row failure` + rollback)
- [x] Replay-failure injection edge coverage complete

## Phase 4 - Surface Simplification

- [x] Duplicate error mapping branches consolidated
- [x] Redundant slot-resolution checks consolidated
- [x] Mirrored comparator logic removed outside canonical helpers

## Phase 5 - Planner and Memory Readiness

- [x] Planner aggregate descriptor/spec consolidation complete
- [x] Aggregate spec unification is all-or-nothing and authoritative
- [x] Terminal surfaces lower to internal aggregate spec early; no late terminal-branch aggregate dispatch
- [x] Fold-state container boundary readiness complete
- [x] Memory-pressure + scan-budget/underfill audit complete
- [x] Ranking-terminal memory semantics documented (full materialization vs bounded growth contract)
- [x] Fold-state lifetime + row-reference retention contracts documented
- [x] Early top-k optimization deferral lock documented and verified

---

## 0.29 Exit Criteria

`0.29` is ready to close when:

1. one aggregate fast-path eligibility gate is authoritative
2. one ranked-row helper family is authoritative
3. cursor terminal-shape signature invariants are test-locked
4. determinism assumptions are explicit and enforced
5. commit/recovery failure boundaries are hardened by tests
6. planner/fold grouped-readiness boundaries are explicit and stable
7. memory-pressure and scan-budget/underfill contracts are explicitly locked pre-`GROUP BY`
8. early top-k optimization remains deferred in `0.29`
9. randomized insertion-order determinism test is green for ranked terminals
10. no new query features were shipped in this milestone

---

## Next Milestone

If the above is complete:

- start `0.30` execution kernel consolidation, then land `GROUP BY` in `0.31`.
