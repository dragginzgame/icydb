# 0.30 Status (as of 2026-02-26)

## 0.30 Scope

This status tracks execution-kernel consolidation from:

- `docs/design/0.30-execution-kernel.md`

`0.30` is structural only. It unifies read execution ownership and defers `GROUP BY` to `0.31`.

---

## In Scope (`0.30.0`)

- establish one canonical route->kernel execution contract (`ExecutionPlan`)
- centralize read execution orchestration under `ExecutionKernel`
- converge load + aggregate + `count_distinct_by` execution ownership
- centralize retry, DISTINCT decoration, predicate compile ownership, and budget/window ownership
- remove duplicate aggregate pipeline orchestration once parity is preserved
- lock behavioral parity for cursor tokens, ordering, strict/subset routing, DISTINCT, and budget behavior

## Out of Scope (`0.30.0`)

- `GROUP BY` implementation (moved to `0.31`)
- full pull-based streaming rewrite
- out-of-core spill/distributed grouping
- commit protocol redesign
- index redesign
- new query terminal feature families

---

## Locked Baselines (Must Hold in 0.30)

- [x] 0.29 continuation/cursor contracts remain unchanged until explicit redesign
- [x] 0.29 deterministic ordering contracts remain unchanged
- [x] 0.29 strict-vs-subset predicate compile parity boundaries remain unchanged
- [x] 0.29 DISTINCT comparator/monotonicity invariants remain unchanged

---

## Release Snapshot (`0.30.0`)

- [ ] `0.30.0` released
- [x] Canonical `ExecutionPlan` contract introduced in executor surface
- [x] Route planner public build functions return `ExecutionPlan`
- [x] Load + aggregate execution signatures switched to consume `ExecutionPlan`
- [x] Transitional `ExecutionKernel` facade introduced
- [x] Load materialization/retry path wired through `ExecutionKernel`
- [x] Canonical residual retry policy moved to `ExecutionKernel`
- [x] DISTINCT application ownership moved fully under `ExecutionKernel`
- [x] Predicate compile-mode execution ownership moved fully under `ExecutionKernel`
- [x] `count_distinct_by` unique orchestration removed
- [x] Aggregate streaming setup converged on one shared preparation boundary
- [x] Aggregate fast-path folding converged on shared helper boundary
- [x] Aggregate materialized execution converged on one shared helper boundary
- [x] Aggregate routed-stream resolution+fold converged on one shared helper boundary
- [x] Aggregate secondary-index probe/fallback folding converged on one shared helper boundary
- [x] Aggregate execution entrypoint delegates to kernel-owned orchestration boundary
- [x] Aggregate reducer dispatch unified behind one kernel adapter boundary
- [x] Duplicate legacy aggregate kernel orchestration path removed
- [x] Kernel aggregate orchestration extracted to `kernel/aggregate.rs`
- [x] Aggregate terminal wrappers split out of `load/aggregate/mod.rs`
- [x] Aggregate fast-path wiring moved under kernel-owned orchestration in `kernel/aggregate.rs`
- [x] Aggregate descriptor/setup contracts split into `load/aggregate/contracts.rs`
- [x] Aggregate orchestration boundary split into `load/aggregate/orchestration.rs`
- [x] `load/aggregate/mod.rs` reduced to wiring-only module boundary (no orchestration/contracts)
- [x] Route planner decomposition completed (`capability/mode/fast_path/hints`)
- [ ] Hard-mode parity + performance gates green
- [x] Changelog entry added for `0.30.0`

Current `0.30.0` status: **in progress (phases 1-4 complete; phase 5 underway)**.

### Implemented in-tree so far

1. Canonical route->kernel contract type:
   - `crates/icydb-core/src/db/executor/execution_plan.rs`
2. Transitional kernel facade:
   - `crates/icydb-core/src/db/executor/kernel/mod.rs`
   - `crates/icydb-core/src/db/executor/kernel/distinct.rs`
3. Route-planner contract wiring:
   - `crates/icydb-core/src/db/executor/route/planner.rs`
4. Load/aggregate type-boundary convergence:
   - `crates/icydb-core/src/db/executor/load/mod.rs`
   - `crates/icydb-core/src/db/executor/load/execute.rs`
   - `crates/icydb-core/src/db/executor/load/aggregate/mod.rs`
5. Kernel-owned retry orchestration:
   - `crates/icydb-core/src/db/executor/kernel/mod.rs`
   - `crates/icydb-core/src/db/executor/load/execute.rs`
6. Kernel-owned distinct application boundary for canonical key-stream resolution:
   - `crates/icydb-core/src/db/executor/kernel/mod.rs`
   - `crates/icydb-core/src/db/executor/kernel/distinct.rs`
   - `crates/icydb-core/src/db/executor/load/execute.rs`
   - `crates/icydb-core/src/db/executor/load/aggregate/mod.rs`
7. Kernel-owned strict/subset predicate compile boundary:
   - `crates/icydb-core/src/db/executor/kernel/predicate.rs`
   - `crates/icydb-core/src/db/executor/load/execute.rs`
   - `crates/icydb-core/src/db/executor/load/aggregate/mod.rs`
   - `crates/icydb-core/src/db/executor/route/planner.rs`
8. Canonical `count_distinct_by` execution-path convergence:
   - `crates/icydb-core/src/db/executor/load/aggregate/distinct.rs`
   - (delegates through canonical load execution via `self.execute(plan)`)
9. Aggregate streaming setup convergence:
   - `crates/icydb-core/src/db/executor/load/aggregate/orchestration.rs`
   - (shared setup boundary for logical-plan conversion, predicate-slot compile, context recovery, and stream binding construction)
10. Aggregate fast-path folding convergence:
   - `crates/icydb-core/src/db/executor/kernel/aggregate.rs`
   - (shared helpers for fast-path DISTINCT decoration + stream fold wiring)
11. Aggregate materialized execution convergence:
   - `crates/icydb-core/src/db/executor/load/aggregate/orchestration.rs`
   - (shared materialized helper for field-target and non-field aggregate terminals)
12. Aggregate routed-stream resolution+fold convergence:
   - `crates/icydb-core/src/db/executor/kernel/aggregate.rs`
   - (shared helper for routed stream resolution and aggregate fold wiring)
13. Aggregate secondary-index probe/fallback fold convergence:
   - `crates/icydb-core/src/db/executor/kernel/aggregate.rs`
   - (shared helper for secondary-index aggregate probe and fallback fold attempts)
14. Kernel-owned aggregate orchestration entrypoint:
   - `crates/icydb-core/src/db/executor/load/aggregate/orchestration.rs`
   - (`LoadExecutor::execute_aggregate_spec` delegates to `ExecutionKernel::execute_aggregate_spec`)
15. Kernel-owned aggregate reducer dispatch adapter:
   - `crates/icydb-core/src/db/executor/kernel/aggregate.rs`
   - (`AggregateReducerDispatch` + `AggregateReducerSelection` now own immediate-vs-streaming aggregate reducer execution split)
16. Legacy aggregate kernel orchestration path removal:
   - `crates/icydb-core/src/db/executor/load/aggregate/mod.rs`
   - (`ExecutionKernel::execute_aggregate_spec_legacy` removed)
17. Kernel aggregate orchestration module extraction:
   - `crates/icydb-core/src/db/executor/kernel/aggregate.rs`
   - (kernel aggregate dispatch, routed-stream fold helper, and secondary probe/fallback helper moved out of load aggregate module)
18. Aggregate terminal wrapper split:
   - `crates/icydb-core/src/db/executor/load/aggregate/terminals.rs`
   - (`load/aggregate/mod.rs` reduced to orchestration/fast-path helpers and non-wrapper aggregate internals)
19. Aggregate fast-path module ownership move:
   - `crates/icydb-core/src/db/executor/kernel/aggregate.rs`
   - (verified-route gate, fast-path dispatch, and shared fast-path fold wiring now owned by kernel)
20. Aggregate contracts + orchestration split:
   - `crates/icydb-core/src/db/executor/load/aggregate/contracts.rs`
   - `crates/icydb-core/src/db/executor/load/aggregate/orchestration.rs`
   - (descriptor/setup contracts and route-bound orchestration moved from root aggregate module)
21. Aggregate root surface reduction:
   - `crates/icydb-core/src/db/executor/load/aggregate/mod.rs`
   - (`load/aggregate` root now keeps module wiring only; shared type alias moved into field helper scope)

---

## Risk Profile (`0.30`)

| Area | Risk |
| --- | --- |
| Kernel introduction | Medium |
| Removing `load/aggregate/mod.rs` | Medium-high |
| Preserving cursor + window parity | High |
| Eliminating remaining aggregate special dispatch branches | Medium |
| Planner split refactor | Low |

Highest-risk boundary:

- cursor + window parity (`continuation` behavior and resume semantics)

---

## Phase Tracker

## Phase 1 - Contract Convergence

- [x] Introduce canonical `ExecutionPlan` boundary type
- [x] Move route planner public contract return types to `ExecutionPlan`
- [x] Update load and aggregate orchestration signatures to consume `ExecutionPlan`
- [x] Introduce transitional `ExecutionKernel` facade
- [x] Route one canonical load materialization/retry call through kernel facade

## Phase 2 - Kernel Ownership

- [x] Move DISTINCT application into kernel-owned boundary
- [x] Move residual retry policy into kernel-owned boundary
- [x] Move strict/subset predicate compile execution ownership into kernel-owned boundary
- [ ] Define and enforce kernel reducer/input contracts (`StreamItem`, `Control`, etc.)

## Phase 3 - Pipeline Convergence

- [x] Converge aggregate streaming-input preparation into one shared setup boundary
- [x] Converge aggregate fast-path folding into shared helper boundary
- [x] Converge aggregate materialized execution into one shared helper boundary
- [x] Converge aggregate routed-stream resolution+fold into one shared helper boundary
- [x] Converge aggregate secondary-index probe/fallback folding into one shared helper boundary
- [x] Move aggregate execution entrypoint orchestration ownership to `ExecutionKernel`
- [x] Introduce a kernel-owned aggregate reducer dispatch adapter boundary
- [x] Remove duplicate legacy aggregate orchestration path
- [x] Extract kernel aggregate orchestration helpers into `kernel/aggregate.rs`
- [x] Split aggregate terminal wrappers into a dedicated module
- [x] Split aggregate fast-path wiring into a dedicated module
- [x] Split aggregate contracts and orchestration into dedicated modules
- [x] Remove remaining duplicate aggregate orchestration branches and special dispatch
- [x] Remove `count_distinct_by` unique execution path
- [x] Keep all aggregate/pagination parity tests unchanged and green

## Phase 4 - Structural Cleanup

- [x] Reduce `load/aggregate/mod.rs` to wiring-only boundary via kernel-owned reducer convergence
- [x] Split `route/planner.rs` into planned submodules without behavior changes
- [x] Keep route capability derivation and access-shape boundaries route-owned

## Phase 5 - Parity + Performance Gates

- [x] Continuation token/signature bytes parity lock (golden tests)
- [x] Strict-vs-subset compile route-decision log parity lock (golden tests)
- [x] Route trace output parity lock
- [ ] No >5% regression on common scan benchmarks
- [x] No new hot-path `Vec` allocation churn introduced

---

## Hard-Mode Pre-Merge Checklist (`0.30`)

- [x] All aggregate tests pass unchanged
- [x] All pagination tests pass unchanged
- [x] Cursor continuation/signature bytes identical before/after (unchanged query shapes)
- [x] Route trace output identical before/after (unchanged plans)
- [ ] Benchmark shows no >5% regression on common scans
- [x] No new `Vec` allocations in documented hot paths
- [x] Golden tests: continuation token equality
- [x] Golden tests: strict/subset compile route-decision logs

---

## Definition of Done (`0.30`)

`0.30` is complete only when all are true:

1. one place calls `resolve_physical_key_stream`
2. one place applies DISTINCT decoration
3. one place applies residual retry policy
4. one place applies predicate compile logic
5. `load/aggregate/mod.rs` is wiring-only (module declarations only; no orchestration/contracts)
6. `count_distinct_by` has no unique execution path
7. `ExecutionKernel` owns all read execution
8. no module outside kernel inspects `AccessPath` internals directly

---

## Verification Readout (Current)

Executed for current 0.30 phase-3/4 slice:

- `cargo fmt --all` (pass)
- `cargo check -p icydb-core` (pass)
- `cargo test -p icydb-core route_matrix_index_predicate_compile_mode_subset_vs_strict_boundary_is_explicit -- --nocapture` (pass)
- `cargo test -p icydb-core strict_index_predicate_compile_policy_has_one_executor_source_of_truth -- --nocapture` (pass)
- `cargo test -p icydb-core route_matrix_aggregate_strict_compile_uncertainty_forces_materialized_execution_mode -- --nocapture` (pass)
- `cargo test -p icydb-core aggregate_execution_mode_selection_is_route_owned_and_explicit -- --nocapture` (pass)
- `cargo test -p icydb-core route::tests::budget -- --nocapture` (pass)
- `cargo test -p icydb-core load_index_only_predicate_distinct_desc_continuation_matches_fallback -- --nocapture` (pass)
- `cargo test -p icydb-core load_index_only_predicate_distinct_continuation_matches_fallback -- --nocapture` (pass)
- `cargo test -p icydb-core load_index_only_predicate_bounded_range_distinct_continuation_matches_fallback_for_asc_and_desc -- --nocapture` (pass)
- `cargo test -p icydb-core aggregate_field_target_count_distinct_residual_retry_parity_and_scan_budget_match_execute -- --nocapture` (pass)
- `cargo test -p icydb-core aggregate_streaming_paths_share_one_preparation_boundary -- --nocapture` (pass)
- `cargo test -p icydb-core aggregate_fast_path_folding_uses_shared_stream_helpers -- --nocapture` (pass)
- `cargo test -p icydb-core aggregate_last_secondary_index_desc_mixed_direction_falls_back_safely -- --nocapture` (pass)
- `cargo test -p icydb-core distinct_stream_suppresses_consecutive_duplicates -- --nocapture` (pass)
- `cargo test -p icydb-core route::tests::planner_mode -- --nocapture` (pass)
- `cargo test -p icydb-core route::tests::planner_capability -- --nocapture` (pass)
- `cargo test -p icydb-core db::executor::tests::aggregate -- --nocapture` (pass)
- `cargo test -p icydb-core db::executor::tests::pagination -- --nocapture` (pass)
- `cargo test -p icydb-core load_offset_pagination_continuation_token_bytes_are_stable_for_same_plan_shape -- --nocapture` (pass)
- `cargo test -p icydb-core route_matrix_strict_vs_subset_decision_logs_are_stable -- --nocapture` (pass)
- `make check-invariants` (pass)
- `make fmt-check && make clippy && make check && make test` (pass)
- allocation audit (pass): no added `Vec`/`collect`/`to_vec` allocation sites across touched hot-path runtime files
  (`kernel/aggregate.rs`, `kernel/reducer.rs`, `load/aggregate/helpers.rs`, `load/aggregate/mod.rs`)

Next verification before merge:

- benchmark regression envelope for common scan paths
