# 0.31 Status (as of 2026-02-27)

## 0.31 Scope

This status tracks deterministic key/equality substrate work from:

- `docs/design/0.31-deterministic-keys.md`

`0.31` is substrate-only and must not ship public `GROUP BY` behavior.

---

## In Scope (`0.31.0`)

- canonical `GroupKey` contract and construction boundary
- stable hash substrate for canonical keys
- explicit equality vs ordering semantic boundaries
- `DISTINCT` semantic boundary lock (row identity vs value equality)
- scan-direction derivation unification (audit cleanup)

## Out of Scope (`0.31.0`)

- aggregate state-machine rewrite (`0.32`)
- `ExecutionShape` rollout (`0.32`)
- planner grouped surface split (`0.33`)
- grouped routing/cursor execution wiring (`0.33`)
- blocking/group cardinality enforcement and estimation

---

## Release Snapshot (`0.31.0`)

- [ ] `0.31.0` released
- [x] Canonical `GroupKey` type introduced
- [x] `CanonicalKey` trait introduced and wired to grouping paths
- [x] Stable hash module introduced under `db/hash/` with fixed-seed guarantees
- [x] Equality and ordering semantics split into explicit contracts
- [x] `DISTINCT` semantic split formalized (`DataKey` row identity vs `GroupKey` value equality)
- [x] Direction derivation unified behind canonical `db::plan` helpers
- [x] Secondary order-pushdown matrix unified behind one canonical owner
- [x] Keep-count/page-window math consolidated between cursor and executor paths

Current `0.31.0` status: **in progress (substrate partially complete)**.

### Implemented in-tree so far

1. Canonical direction derivation helpers:
   - `crates/icydb-core/src/db/plan/mod.rs`
   - used by route/load/executable-plan callsites.
2. Canonical secondary pushdown applicability owner:
   - `crates/icydb-core/src/db/query/plan.rs`
   - consumed by route capability via `db::plan` re-export.
3. Canonical keep-count/page-window math:
   - `crates/icydb-core/src/db/plan/mod.rs`
   - reused by `db::executor::window` and `db::cursor::continuation`.
4. Canonical key/equality substrate for aggregate distinct paths:
   - `crates/icydb-core/src/db/group_key.rs`
   - `crates/icydb-core/src/db/hash/mod.rs`
   - `count_distinct_by` and `distinct_values_by` now dedupe via `GroupKeySet`.
5. Equality/order semantic boundary contracts:
   - `crates/icydb-core/src/db/contracts/semantics.rs`
   - ordering paths call canonical order contract (`cursor/boundary`)
   - distinct dedupe paths use direct equality contracts (no comparator-equals dedupe).

---

## Phase Tracker

### Phase 1 - Key Canonicalization Substrate

- [x] Introduce `GroupKey` with opaque canonical construction
- [x] Introduce `CanonicalKey` and canonicalization errors
- [x] Canonical map/decimal normalization locked with tests

### Phase 2 - Stable Hash Substrate

- [x] Introduce stable hash type and implementation under `db/hash/`
- [ ] Lock fixed-seed and upgrade-stability contracts
- [ ] Add hash/canonical-equality invariance tests

### Phase 3 - Equality/Ordering Split

- [x] Introduce explicit equality semantics boundary
- [x] Introduce explicit ordering semantics boundary
- [x] Remove comparator-based equality in grouping/distinct paths

### Phase 4 - DISTINCT Semantic Boundary Lock

- [x] Lock row-level DISTINCT semantics to `DataKey` identity
- [x] Lock value-level DISTINCT semantics to canonical `GroupKey` equality
- [x] Keep ordering and continuation behavior parity locked

Current result: aggregate field-target distinct reducers (`count_distinct_by`, `distinct_values_by`)
dedupe via `GroupKeySet`; kernel row-level DISTINCT decoration uses explicit `DataKey`
equality + comparator monotonic-order checks by design (no `GroupKey` migration at this boundary).

### Phase 5 - Audit Cleanup / Drift Reduction

- [x] Direction derivation unification
- [x] Secondary pushdown matrix unification
- [x] Keep-count/page-window consolidation

---

## Exit Criteria (`0.31`)

`0.31` is complete when all are true:

1. canonical key materialization is the only path for grouping equality
2. stable hash is deterministic across upgrades
3. equality and ordering semantics are explicitly separated and enforced
4. DISTINCT domains are explicit and enforced:
   - kernel row DISTINCT uses `DataKey` identity
   - value DISTINCT uses canonical `GroupKey` equality
   - no comparator-based equality dedupe remains in grouping/distinct paths
5. no public grouped execution behavior is exposed

---

## Verification Readout (Current)

Executed for current `0.31`-aligned cleanup slice:

- `cargo fmt --all` (pass)
- `cargo check -p icydb-core --all-targets --locked` (pass)
- `cargo test -p icydb-core group_key --locked` (pass)
- `cargo test -p icydb-core stable_hash_ --locked` (pass)
- `cargo test -p icydb-core aggregate_field_target_count_distinct_counts_window_values --locked` (pass)
- `cargo test -p icydb-core aggregate_field_target_distinct_values_by_matches_effective_window_projection --locked` (pass)
- `cargo test -p icydb-core distinct_stream_ --locked` (pass)
- `cargo test -p icydb-core distinct_stream_identity_equality_never_emits_same_datakey_twice --locked` (pass)
- `cargo test -p icydb-core stream_key --locked` (pass)
- `cargo test -p icydb-core load_distinct_flag_preserves_union_pagination_rows_and_boundaries --locked` (pass)
- `cargo test -p icydb-core load_row_distinct_keeps_rows_with_same_projected_values_when_datakey_differs --locked` (pass)
- `cargo test -p icydb-core canonical_group_key_equality_matches_key_contract --locked` (pass)
- `cargo test -p icydb-core set_literals_are_sorted_and_deduplicated --locked` (pass)
- `cargo test -p icydb-core secondary_order_pushdown --locked` (pass)
- `cargo test -p icydb-core executor_save_then_delete_round_trip --locked` (pass)
- `cargo test -p icydb-core delete_emits_remove_from_prepared_row_deltas --locked` (pass)
- `cargo clippy -p icydb-core --all-targets --locked -- -D warnings` (blocked: `Invalid cross-device link (os error 18)`)
