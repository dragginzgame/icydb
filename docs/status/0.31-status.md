# 0.31 Status (as of 2026-02-27)

## 0.31 Scope

This status tracks deterministic key/equality substrate work from:

- `docs/design/0.31-deterministic-keys.md`

`0.31` is substrate-only and must not ship public `GROUP BY` behavior.

---

## In Scope (`0.31.0`)

- canonical `GroupKey` contract and construction boundary
- stable hash substrate for canonical keys
- explicit equality vs ordering semantic boundaries
- `DISTINCT` substrate migration to canonical key semantics
- scan-direction derivation unification (audit cleanup)

## Out of Scope (`0.31.0`)

- aggregate state-machine rewrite (`0.32`)
- `ExecutionShape` rollout (`0.32`)
- planner grouped surface split (`0.33`)
- grouped routing/cursor execution wiring (`0.33`)
- blocking/group cardinality enforcement and estimation

---

## Release Snapshot (`0.31.0`)

- [ ] `0.31.0` released
- [ ] Canonical `GroupKey` type introduced
- [ ] `CanonicalKey` trait introduced and wired to grouping paths
- [ ] Stable hash module introduced under `db/hash/` with fixed-seed guarantees
- [ ] Equality and ordering semantics split into explicit contracts
- [ ] `DISTINCT` migrated to canonical key substrate
- [x] Direction derivation unified behind canonical `db::plan` helpers
- [x] Secondary order-pushdown matrix unified behind one canonical owner
- [x] Keep-count/page-window math consolidated between cursor and executor paths

Current `0.31.0` status: **in progress (substrate partially complete)**.

### Implemented in-tree so far

1. Canonical direction derivation helpers:
   - `crates/icydb-core/src/db/plan/mod.rs`
   - used by route/load/executable-plan callsites.
2. Canonical secondary pushdown applicability owner:
   - `crates/icydb-core/src/db/query/plan.rs`
   - consumed by route capability via `db::plan` re-export.
3. Canonical keep-count/page-window math:
   - `crates/icydb-core/src/db/plan/mod.rs`
   - reused by `db::executor::window` and `db::cursor::continuation`.

---

## Phase Tracker

### Phase 1 - Key Canonicalization Substrate

- [ ] Introduce `GroupKey` with opaque canonical construction
- [ ] Introduce `CanonicalKey` and canonicalization errors
- [ ] Canonical map/decimal/bigint normalization locked with tests

### Phase 2 - Stable Hash Substrate

- [ ] Introduce stable hash type and implementation under `db/hash/`
- [ ] Lock fixed-seed and upgrade-stability contracts
- [ ] Add hash/canonical-equality invariance tests

### Phase 3 - Equality/Ordering Split

- [ ] Introduce explicit equality semantics boundary
- [ ] Introduce explicit ordering semantics boundary
- [ ] Remove comparator-based equality in grouping/distinct paths

### Phase 4 - DISTINCT Substrate Migration

- [ ] Move DISTINCT to canonical key semantics without behavior drift
- [ ] Keep ordering and continuation behavior parity locked

### Phase 5 - Audit Cleanup / Drift Reduction

- [x] Direction derivation unification
- [x] Secondary pushdown matrix unification
- [x] Keep-count/page-window consolidation

---

## Exit Criteria (`0.31`)

`0.31` is complete when all are true:

1. canonical key materialization is the only path for grouping equality
2. stable hash is deterministic across upgrades
3. equality and ordering semantics are explicitly separated and enforced
4. DISTINCT uses canonical key substrate
5. no public grouped execution behavior is exposed

---

## Verification Readout (Current)

Executed for current `0.31`-aligned cleanup slice:

- `cargo fmt --all` (pass)
- `cargo check -p icydb-core --all-targets --locked` (pass)
- `cargo test -p icydb-core secondary_order_pushdown --locked` (pass)
- `cargo test -p icydb-core executor_save_then_delete_round_trip --locked` (pass)
- `cargo test -p icydb-core delete_emits_remove_from_prepared_row_deltas --locked` (pass)
