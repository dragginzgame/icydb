# 0.25 Status (as of 2026-02-23)

## 0.25 Scope

This status tracks aggregate expansion from:

- `docs/design/0.25-aggregate-expansion.md`

In scope for `0.25`:

- index-aware field extrema support (`min(field)` / `max(field)`) for explicitly eligible shapes
- explicit eligibility boundaries for which field/access combinations can use fast paths
- parity-safe fallback to canonical execution when eligibility is not met
- documentation of supported aggregate/field combinations and known exclusions

Out of scope for `0.25`:

- cursor model redesign
- planner cost-model redesign
- new continuation envelope formats
- broad DSL expansion unrelated to aggregate capabilities

---

## Release Snapshot

- [ ] `0.25.0` released (`Cargo.toml` version is still `0.24.7`)
- [x] Milestone tracker created
- [x] Field aggregate terminals landed on load queries (`min_by`, `max_by`, `nth_by`, `sum_by`, `avg_by`, `median_by`, `count_distinct_by`, `min_max_by`)
- [x] Fail-fast validation for invalid field targets added before scan work begins
- [x] Deterministic field-extrema tie-break behavior locked to `(field_value, primary_key_asc)`
- [x] Route-owned field-extrema eligibility reasons and matrix tests added
- [x] Eligible field-extrema shapes route through fast paths, with parity-safe fallback for ineligible shapes
- [x] Session parity coverage added for field-target extrema and numeric field aggregates, including `median_by`, `count_distinct_by`, and `min_max_by`
- [x] Final docs matrix for supported field/type combinations published (design + status)
- [x] Full release-gate sweep re-run and recorded for the `0.25.0` cut

Overall status: **release-ready in-tree; `0.25` capability + docs + verification gates are complete, pending only final version cut/alignment (`Cargo.toml` still `0.24.7`)**.

---

## Current Baseline

- `FluentLoadQuery` exposes `min_by`, `max_by`, `nth_by`, `sum_by`, `avg_by`, `median_by`, `count_distinct_by`, and `min_max_by`.
- `min_by`/`max_by` tie handling is deterministic: compare field value first, then primary key ascending.
- `nth_by` is zero-based and returns `None` when `n` is outside the current query window.
- `median_by` uses deterministic field order (`field asc`, then primary key asc) and picks the lower median for even-length windows.
- `count_distinct_by` counts unique field values in the effective result window (including non-orderable field kinds via equality semantics).
- `min_max_by` returns `Option<(Id<E>, Id<E>)>` (empty window => `None`) in one terminal call and keeps deterministic primary-key tie-break behavior.
- `sum_by`/`avg_by` project numeric fields to `Decimal`, with `None` for empty windows.
- Unsupported targets (unknown field, non-orderable field, non-numeric field where required) fail with typed `Unsupported` errors before scan-budget consumption.
- Route remains the sole authority for field-extrema fast-path eligibility and ineligibility reasons.

Example usage:

```rust
let median_rank_id = session
    .load::<User>()
    .filter_expr(FilterExpr::eq(User::GROUP, 7))?
    .order_by("id")
    .median_by("rank")?;

let distinct_rank_count = session
    .load::<User>()
    .filter_expr(FilterExpr::eq(User::GROUP, 7))?
    .order_by("id")
    .count_distinct_by("rank")?;

let min_max_rank_ids = session
    .load::<User>()
    .filter_expr(FilterExpr::eq(User::GROUP, 7))?
    .order_by("id")
    .min_max_by("rank")?;
```

---

## Explicit Capability Matrix (Field Terminals)

| Aggregate terminal | DISTINCT supported | Fast path eligible |
| --- | --- | --- |
| `min_by(field)` | Yes (canonical fallback when fast-path-ineligible) | Yes, route-gated and only for explicitly eligible non-`DISTINCT` shapes |
| `max_by(field)` | Yes (canonical fallback when fast-path-ineligible) | Yes, route-gated and only for explicitly eligible non-`DISTINCT` shapes |
| `nth_by(field, n)` | Yes (canonical fallback path) | No (`0.25` has no `nth_by` fast path) |
| `sum_by(field)` | Yes (canonical fallback path) | No (`0.25` has no `sum_by` fast path) |
| `avg_by(field)` | Yes (canonical fallback path) | No (`0.25` has no `avg_by` fast path) |
| `median_by(field)` | Yes (canonical fallback path) | No (`0.25` has no `median_by` fast path) |
| `count_distinct_by(field)` | Yes (canonical fallback path) | No (`0.25` has no `count_distinct_by` fast path) |
| `min_max_by(field)` | Yes (canonical fallback path) | No (`0.25` has no `min_max_by` fast path) |

Note: for field extrema, `DISTINCT` currently disables fast-path eligibility by design and routes to canonical fallback (`DistinctNotSupported` in route capability reasons). For `count_distinct_by`, `DISTINCT` only affects the effective window row set before terminal reduction; field-distinct semantics are unchanged.

---

## Continuation Contract (Field Terminals)

| Terminal | Continuation allowed | Behavior |
| --- | --- | --- |
| `min_by` | No | Terminal query only; cursor token on non-paged terminal is explicitly rejected (`CursorRequiresPagedExecution`) |
| `max_by` | No | Terminal query only; cursor token on non-paged terminal is explicitly rejected (`CursorRequiresPagedExecution`) |
| `nth_by` | No | Terminal query only; cursor token on non-paged terminal is explicitly rejected (`CursorRequiresPagedExecution`) |
| `sum_by` | No | Terminal query only; cursor token on non-paged terminal is explicitly rejected (`CursorRequiresPagedExecution`) |
| `avg_by` | No | Terminal query only; cursor token on non-paged terminal is explicitly rejected (`CursorRequiresPagedExecution`) |
| `median_by` | No | Terminal query only; cursor token on non-paged terminal is explicitly rejected (`CursorRequiresPagedExecution`) |
| `count_distinct_by` | No | Terminal query only; cursor token on non-paged terminal is explicitly rejected (`CursorRequiresPagedExecution`) |
| `min_max_by` | No | Terminal query only; cursor token on non-paged terminal is explicitly rejected (`CursorRequiresPagedExecution`) |

Sign-off: `0.25` field aggregate terminals are non-paged terminal endpoints; continuation cursors are intentionally not part of their contract.

---

## Acceptance Gate Readout

1. User-visible capability gate: **met** (`min_by`/`max_by` and additional field aggregates are available in the load-query surface).
2. Parity gate: **met in targeted coverage**, with field aggregate parity tests against canonical execute behavior.
3. Direction gate: **met in targeted coverage**, including DESC and tie-break scenarios for field extrema.
4. Window/distinct gate: **met**; window behavior is covered and DISTINCT parity is locked for field terminals via canonical fallback where field-extrema fast path is intentionally ineligible.
5. Continuation gate: **met**; field aggregate terminals are non-paged terminal endpoints and reject cursor continuation explicitly.
6. Consistency gate: **met in targeted coverage**; `Unsupported` fail-fast behavior plus `Strict`/`MissingOk` stale-leading field-extrema behavior are covered.
7. Route stability gate: **met in targeted matrix coverage** for field-extrema eligibility and fallback reasons.

---

## Next Slice

1. Cut `0.25.0` by aligning `Cargo.toml` version and final release metadata.
2. After publish, flip the release checkbox and retain this file as the milestone sign-off record.

---

## Verification Run (this pass)

- `make fmt-check` (pass)
- `make clippy` (pass)
- `TMPDIR=/home/adam/projects/icydb/tmp_relcheck cargo check --workspace` (pass)
- `TMPDIR=/home/adam/projects/icydb/tmp_relcheck cargo test --workspace --all-targets` (pass)
- `TMPDIR=/home/adam/projects/icydb/tmp_relcheck cargo test -p icydb-core aggregate_field_terminal_parity_distinct -- --nocapture` (pass)
- `TMPDIR=/home/adam/projects/icydb/tmp_relcheck cargo test -p icydb-core aggregate_field_extrema_ -- --nocapture` (pass)
- `TMPDIR=/home/adam/projects/icydb/tmp_relcheck cargo test -p icydb-core aggregate_field_parity_matrix_harness_covers_all_rank_terminals -- --nocapture` (pass)

Environment note:
- `make check` was attempted but is unstable in this environment due `Invalid cross-device link (os error 18)` when writing `target/debug/*.rmeta`.
- Equivalent release verification was completed successfully with direct cargo commands using workspace-local `TMPDIR`.
