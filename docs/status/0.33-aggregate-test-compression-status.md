# 0.33 Aggregate Test Compression Status (as of 2026-02-28)

## Scope

This milestone tracks conceptual compression of aggregate test coverage centered on:

- `crates/icydb-core/src/db/executor/tests/aggregate.rs` (baseline: `7493` LOC)

Primary goal: preserve behavior while reducing duplicate assertion shape and making
coverage ownership explicit via a canonical behavior matrix.

---

## Canonical Matrix Axes

Every aggregate test row should map to one behavior cell:

- capability (`terminal`, `field_terminal`, `projection`, `scan_budget`, `error_class`)
- path (`full_scan`, `key_range`, `index_range`, `secondary_index`, `fast_path`, `kernel`)
- nullability (`non_nullable`, `nullable`, `missing_field`, `non_orderable`, `numeric_only`)
- grouping mode (`ungrouped`, `grouped`)

---

## Milestone Phases

- [x] Phase 1: Introduce matrix-driven harness for duplicated rank-terminal direction invariance.
- [x] Phase 2: Classify all current aggregate tests into `contract`, `path_parity`, `regression`.
- [ ] Phase 3: Replace duplicated terminal assertion clusters with table-driven rows per invariant.
- [ ] Phase 4: Move unsupported combinations to spec-build-time rejection vectors where feasible.
- [ ] Phase 5: Split monolithic aggregate tests into module files by invariant family with stable boundaries.

---

## Completed in This Slice

- Added a canonical ranked-terminal matrix harness:
  - `session_load_ranked_terminals_direction_invariance_matrix`
  - `session_load_ranked_terminals_direction_invariance_matrix_covers_all_rank_terminals`
- Collapsed six duplicated ASC/DESC direction-invariance tests into one table-driven invariant.
- Added a canonical ranked `k=1` extrema-equivalence matrix harness:
  - `aggregate_field_target_rank_k_one_extrema_equivalence_matrix`
  - `aggregate_field_target_rank_k_one_extrema_equivalence_matrix_covers_all_projection_forms`
- Collapsed six duplicated `k=1` extrema-equivalence tests into one table-driven invariant.
- Added a canonical projection scan-budget parity matrix harness:
  - `aggregate_field_target_projection_terminals_preserve_scan_budget_parity_with_execute_matrix`
  - `aggregate_field_target_projection_terminals_scan_budget_matrix_covers_all_forms`
- Collapsed three duplicated projection scan-budget parity tests into one table-driven invariant.
- Added a canonical session ranked projection-parity matrix harness:
  - `session_load_ranked_projection_terminals_match_ranked_rows_matrix`
  - `session_load_ranked_projection_terminals_matrix_covers_all_forms`
- Collapsed four duplicated session ranked projection-parity tests into one table-driven invariant.
- Added a canonical session execute-projection matrix harness:
  - `session_load_projection_terminals_match_execute_projection_matrix`
  - `session_load_projection_terminals_execute_projection_matrix_covers_all_forms`
- Collapsed three duplicated session execute-projection parity tests into one table-driven invariant.
- Added a canonical bounded rank-window oracle matrix harness:
  - `aggregate_field_target_rank_terminals_bounded_window_scan_budget_and_oracle_matrix`
- Collapsed two duplicated bounded rank-window tests into one table-driven invariant.
- Added a canonical forced-shape execute-oracle matrix harness:
  - `aggregate_field_target_rank_terminals_forced_shape_execute_oracle_matrix`
- Collapsed two duplicated forced-shape rank-terminal oracle tests into one table-driven invariant.
- Added a canonical simple-terminal short-circuit matrix harness:
  - `aggregate_simple_terminal_short_circuit_and_direction_matrix`
- Collapsed seven duplicated simple-terminal short-circuit/direction tests into one table-driven invariant.
- Added a canonical DESC cursor-resume parity matrix harness:
  - `desc_cursor_resume_matrix_matches_unbounded_execution`
- Collapsed three duplicated DESC cursor-resume tests into one table-driven invariant.
- Split aggregate test matrices into dedicated child modules:
  - `crates/icydb-core/src/db/executor/tests/aggregate/core_contract_matrices.rs`
  - `crates/icydb-core/src/db/executor/tests/aggregate/field_projection_matrices.rs`
  - `crates/icydb-core/src/db/executor/tests/aggregate/path_parity_matrices.rs`
  - `crates/icydb-core/src/db/executor/tests/aggregate/secondary_index_matrices.rs`
  - `crates/icydb-core/src/db/executor/tests/aggregate/session_matrices.rs`
  - `crates/icydb-core/src/db/executor/tests/aggregate/ranked_matrices.rs`
  - `crates/icydb-core/src/db/executor/tests/aggregate/tail_matrices.rs`
  - `crates/icydb-core/src/db/executor/tests/aggregate/projection_matrices.rs`
  - root file reduced from `8090` lines to `1129` lines
  - aggregate module total (root + child files) reduced from `8090` lines to `7408` lines
- Added explicit behavior-cell metadata (`capability x path x nullability x grouping`) to matrix rows.
- Consolidated wrapper-style parity tests into matrix tests, reducing aggregate
  test entrypoints from `122` to `106` while preserving invariant coverage.
- Collapsed strict-prefilter scan-reduction checks into a shared aggregate matrix helper:
  - `aggregate_strict_prefilter_reduces_scan_vs_uncertain_fallback`
- Added full inventory listing and reproducible completeness checks in:
  - `docs/status/0.33-aggregate-test-inventory-status.md`

---

## Exit Criteria

This milestone is complete when all are true:

1. every aggregate test maps to one declared matrix cell
2. duplicated assertions are represented by table-driven invariants
3. unsupported-state behavior is verified at spec-build boundaries instead of runtime-only regression tests
4. aggregate test files are split by contract class (`contract`, `path_parity`, `regression`) with clear ownership
