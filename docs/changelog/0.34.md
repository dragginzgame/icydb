# IcyDB 0.34

This document aggregates detailed release notes for the `0.34.x` minor line.

---

## 0.34.0 - 2026-02-28 - Commit Narrative Consolidation and No-Shim Recovery

### ðŸ“ Summary

0.34.0 starts the `0.34` clarity/consolidation track with a focused pass over commit execution internals, improving module responsibility narration and phase-level invariant readability while also removing compatibility shims in the commit recovery path.

### ðŸ”§ Changed - Commit Module Narrative

- Added explicit module-boundary responsibility headers in `db::commit::{apply,prepare,replay}` to document semantic ownership and one-way layer dependencies.
- Added phase-level comments in long commit preparation/replay/apply paths to make ordering assumptions and fail-closed behavior explicit at the call-site level.
- Clarified mechanical-apply sequencing intent (`index -> row`) and deterministic replay/rebuild flow, reducing ambiguity for future structural consolidation work.
- Split prepared-op payload ownership into a dedicated `db::commit::prepared_op` module and kept `db::commit::apply` focused on mutation application behavior.
- Split recovery index-rebuild ownership into a dedicated `db::commit::rebuild` module and kept `db::commit::replay` focused on marker row-op replay.
- Extended the same boundary/phase comment pass through `db::commit::{store,memory,rollback}` and removed a one-call recovery marker-clear wrapper in favor of direct `with_commit_store(...).clear_infallible()` at the recovery boundary.

### ðŸ”§ Changed - Compatibility Removal

- Removed the write-only recovery shim (`ensure_recovered_for_write`) and converged call sites on `ensure_recovered`.
- Removed commit-marker schema-fingerprint fallback behavior: replay now requires explicit fingerprint presence and exact match.

### ðŸ”§ Changed - Data Module Narrative

- Added module-boundary responsibility headers across `db::data::{mod,entity_decode,key,row,storage_key,store}` to make ownership and one-way dependency flow explicit.
- Added phase comments to non-trivial key/row encode-decode paths (`DataKey`, `StorageKey`, entity decode helpers) and refreshed stale comment wording to match current control flow.
- Clarified `DataStore` boundary narration as a thin persistence wrapper that assumes prevalidated inputs from higher layers.

### ðŸ”§ Changed - Index Module Narrative

- Added module-boundary responsibility headers across `db::index` and nested key/planning/predicate modules, including `index::key::{codec,ordered}` internals.
- Added phase-level comments in non-trivial index flows (raw key codec encode/decode, index-entry validation, range lowering, store range scan, and index mutation planning).
- Refreshed stale comments to match current control flow and tightened import placement in `index::store` by keeping module imports at top-of-file.
- Split raw-range scan/continuation resolution out of `db::index::store` into a dedicated `db::index::scan` module; `index::store` now owns persistence primitives only.
- Consolidated continuation-envelope helpers (`resume_bounds_from_refs`, `anchor_within_envelope`, `continuation_advanced`) under `db::index::envelope`, removing split authority across `range` and `envelope`.

### ðŸ”§ Changed - Predicate Module Narrative

- Added module-boundary responsibility headers across `db::predicate::{mod,coercion,fingerprint,model,normalize,resolved,row_policy,runtime,schema,semantics}`.
- Added light phase commentary in key compile/evaluation boundaries (`normalize`, `runtime`, and semantic compare helpers) and refreshed stale wording for current control flow.
- Preserved behavior while clarifying ownership boundaries between normalization, validation, runtime execution, and comparison semantics.

### ðŸ”§ Changed - Access Module Narrative

- Added module-boundary responsibility headers across `db::access::{mod,canonical,lowering,path,plan,validate}`.
- Added targeted phase comments for access-plan lowering boundaries and refreshed stale wording, including a small adapter comment typo cleanup.
- Kept access behavior unchanged while making planner/lowering/executor ownership boundaries explicit.
- Moved index-range "not indexable" reason scope/wording mapping into `db::access::lowering`; `db::index::range` now exposes only structural lowering reasons (`IndexRangeBoundEncodeError`).

### ðŸ”§ Changed - Query Module Narrative

- Added module-boundary responsibility headers across `db::query` surfaces touched in this pass, including `builder`, `expr`, `fluent`, `intent`, `plan::group`, `explain`, and `fingerprint`.
- Added phase-level comments in non-trivial query paths (`FilterExpr::lower_with`, key-access lowering in `intent`, grouped handoff projection, explain projection, and fingerprint/signature hashing).
- Refreshed stale/placeholder API doc comments in `query::explain` and `query::fingerprint` to align comments with current semantics and prevent drift.
- Kept query behavior unchanged while tightening ownership narration between intent, planning, explain, and hash surfaces.

### ðŸ”§ Changed - Query Plan Pushdown Modularization

- Extracted secondary ORDER BY pushdown matrix logic from `db::query::plan::mod` into a dedicated `db::query::plan::pushdown` submodule.
- Moved dense pushdown helpers (`match_secondary_order_pushdown_core`, `assess_secondary_order_pushdown_for_plan`, and related applicability derivation) behind that focused module boundary.
- Kept behavior unchanged and preserved existing call surfaces via re-exports from `query::plan`.

### ðŸ”§ Changed - Relation Save Validation Authority

- Moved save-time strong-relation traversal/existence validation out of `executor::mutation::save_validation` into a dedicated `db::relation::save_validate` module.
- Added `relation::validate_save_strong_relations(...)` as the single relation-owned save validation entrypoint and switched executor preflight to delegate to it.
- Kept error classes/messages and runtime behavior unchanged while consolidating relation semantics under `db::relation`.

### ðŸ”§ Changed - Index PK Equivalence Naming

- Renamed `db::index::contracts` to `db::index::pk_equivalence` to make ownership explicit for primary-key equivalence checks used by cursor anchor validation.
- Kept behavior unchanged; this is a naming/authority clarity cleanup only.

### ðŸ”§ Changed - Paged Response Payload Placement

- Moved `PagedLoadExecution` and `PagedLoadExecutionWithTrace` out of `db::mod` into `db::response::paged`.
- Kept caller-facing API stable by re-exporting through `db::response` and the `db` root.
- Kept behavior unchanged; this is a DTO ownership/location cleanup.

### ðŸ”§ Changed - Cursor Plan Surface Refactor

- Added a thin cursor plan-surface contract in `db::cursor::spine` and refactored structured cursor validation to consume that surface instead of threading many independent plan parameters.
- Kept cursor behavior unchanged while reducing parameter fan-out inside the cursor validation pipeline.

### ðŸ§­ Migration Notes

- Internal commit/recovery APIs are intentionally non-backward-compatible in this release (shim paths removed).
- Legacy commit markers without schema fingerprints are no longer replayable.

### ðŸ§ª Testing

- Re-ran `cargo check -p icydb-core` after the commit-module refactors and no-shim compatibility removals.
- Re-ran `cargo check -p icydb-core --tests` after the `db::data` narrative pass.
- Re-ran `cargo check -p icydb-core --tests` after the `db::index` narrative pass.
- Re-ran `cargo check -p icydb-core --tests` after the `db::index::store` / `db::index::scan` split.
- Re-ran `cargo check -p icydb-core --tests` after consolidating continuation-envelope helpers into `db::index::envelope`.
- Re-ran `cargo check -p icydb-core --tests` after the `db::predicate` narrative pass.
- Re-ran `cargo check -p icydb-core --tests` after the `db::access` narrative pass.
- Re-ran `cargo check -p icydb-core --tests` after moving not-indexable reason mapping to `db::access::lowering`.
- Re-ran `cargo check -p icydb-core --tests` after the `db::query` narrative/comment pass.
- Re-ran `cargo check -p icydb-core --tests` after moving save-time strong relation validation into `db::relation::save_validate`.
- Re-ran `cargo check -p icydb-core --tests` after renaming `db::index::contracts` to `db::index::pk_equivalence`.
- Re-ran `cargo check -p icydb-core --tests` after moving paged load response DTOs into `db::response::paged`.
- Re-ran `cargo check -p icydb-core --tests` after the cursor plan-surface refactor in `db::cursor::spine`.
- Re-ran `cargo check -p icydb-core --tests` after extracting query pushdown matrix logic into `db::query::plan::pushdown`.
