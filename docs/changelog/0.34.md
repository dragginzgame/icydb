# IcyDB 0.34

This document aggregates detailed release notes for the `0.34.x` minor line.

---

## 0.34.3 - 2026-03-01 - Route Staging and Stream Access Ownership

### ðŸ“ Summary

0.34.3 continues the `0.34.x` cleanup track with boundary-focused executor routing and stream access consolidation.

### ðŸ”§ Changed - Stream Access Ownership

- Moved physical access-path resolution from the executor root into the stream-access boundary, co-locating physical key resolution with access stream traversal.
- Kept scan behavior unchanged while reducing executor root-module noise and clarifying that physical path resolution is a stream concern.
- Updated invariant guard wiring to follow the new physical resolver location under stream access.

### ðŸ”§ Changed - Route Planner Staging

- Split route planner staging into dedicated intent, feasibility, and execution submodules.
- Kept intent derivation pure and isolated from downstream feasibility/execution concerns.
- Kept execution-mode resolution downstream of feasibility derivation, including using staged feasibility metadata instead of re-reading plan surface directly during execution-stage checks.

### ðŸ”§ Changed - Aggregate Contract Decomposition

- Split the aggregate contracts surface into focused modules for spec, state, grouped execution substrate, and error taxonomy.
- Preserved dependency direction so spec remains execution-agnostic and state/grouped layers consume contracts without inverting authority.
- Reduced monolithic contract-file density ahead of grouped/runtime expansion work.

---

## 0.34.2 - 2026-03-01 - Cursor/Route Contract Consolidation

### ðŸ“ Summary

0.34.2 focused on consolidating cursor and route contract authority so planner/executor boundaries stay explicit ahead of `0.35`.

### ðŸ”§ Changed - Cursor Boundary Cleanup

- Split cursor error taxonomy/construction into a dedicated cursor error boundary and routed cursor validation call sites through constructors instead of direct variant assembly.
- Extracted grouped cursor decode/signature/direction/window validation into a dedicated grouped-validation module so cursor root wiring stays thin.
- Split continuation token ownership into focused token submodules (scalar/grouped/wire) to separate wire-format concerns from cursor validation semantics.
- Kept cursor-signature formatting ownership at the codec boundary while cursor-domain signatures remain byte-first semantic values.

### ðŸ”§ Changed - Route Contract Authority

- Finalized route contracts as data/contracts-only surface and kept algorithmic helpers in dedicated ownership modules.
- Tightened route helper placement so capability predicates, fast-path probing, and planner-stage assembly live in their respective route subdomains.
- Preserved route behavior while reducing drift risk from helper sprawl in generic contract files.

### ðŸ”§ Changed - Surface Cleanup

- Continued db-module consolidation and stale-comment cleanup to keep semantic authority aligned with current module ownership.
- Updated governance/readiness notes for the grouped-readiness track so planning assumptions match the current architecture state.

---

## 0.34.1 - 2026-02-28 - Query Pushdown Boundary and Cursor Invariant Guardrails

### ðŸ“ Summary

0.34.1 is a patch checkpoint that tightens planning/cursor authority boundaries after the 0.34.0 consolidation pass.

### ðŸ”§ Changed - Query Plan Boundary

- Moved secondary ORDER BY pushdown matrix evaluation out of `db::query::plan::mod` into `db::query::plan::pushdown` to reduce semantic density in the root plan module.
- Kept planner-facing call surfaces stable through `query::plan` re-exports while isolating dense pushdown matching helpers behind a dedicated submodule.

### ðŸ”§ Changed - Aggregate Semantic Authority

- Strengthened `AggregateKind` documentation contract to explicitly require executor traversal/fold direction derivation from `AggregateKind` alone, preventing direction policy drift into executor-local branching.

### ðŸ”§ Changed - Executor Boundary Narrative (Phase 1)

- Added explicit module-boundary responsibility headers across executor top-level surfaces (`executor::mod`, `compile_bridge`, `preparation`, `plan_validate`, and `executable_plan`) to keep semantic ownership and one-way dependency flow clear.
- Added phase comments in non-trivial executor preparation/binding paths (plan lowering and cursor entry gates) to make invariant checks and delegation boundaries easier to audit.
- Added route module boundary headers (`route::{mod,mode,guard,hints}`) and refreshed stale route subdomain wording to match the current split architecture.

### ðŸ”§ Changed - Route Contract Consolidation

- Split route contract payloads/types/constants out of `db::executor::route::mod` into a dedicated `db::executor::route::contracts` module, reducing root-module density while keeping existing route call surfaces stable via root re-exports.
- Kept route planning/capability/hint behavior unchanged; this is a structural authority cleanup only.
- Tightened `route::contracts` to a data/contracts-only surface (no algorithm helpers), and moved helper ownership to dedicated modules:
  - `supports_pk_stream_access_path` and `direction_allows_physical_fetch_hint` -> `route::capability`
  - `try_first_verified_fast_path_hit` -> `route::fast_path`
  - `RouteWindowPlan::new`, grouped observability projection, and mutation route constructor -> `route::planner`

### ðŸ”§ Changed - Preparation Ownership Cleanup

- Moved index slot-map resolution for single-path index access shapes from `route::capability` into `executor::preparation`, aligning that helper with its only runtime consumer.
- Refreshed stale route capability comments that still referenced older `0.24.x` phrasing.

### ðŸ”§ Changed - Small Module Consolidations

- Collapsed `db::response::write` into `db::response::mod` so write response payload contracts live directly in the response boundary module.
- Collapsed `db::executor::compile_bridge` into `db::executor::mod`, keeping compiled-query to executable-plan conversion at the executor boundary root.

### ðŸ”§ Changed - Cursor Signature Codec Boundary

- Moved `ContinuationSignature` hex/display formatting ownership from `db::cursor::signature` into `db::codec::cursor`, keeping signature value semantics byte-only in cursor domain while delegating token formatting to codec boundary.

### ðŸ©¹ Fixed - Cursor Spine Invariant Enforcement

- Restored explicit expected-vs-actual invariant checks in cursor spine validation for direction and initial offset (`validate_cursor_direction(expected_direction, actual_direction)` and `validate_cursor_window_offset(expected_initial_offset, actual_initial_offset)`), keeping continuation boundary validation authority unambiguous.

### ðŸ§ª Testing

- Re-ran `cargo check -p icydb-core --tests` after the executor top-level narration pass.
- Re-ran `cargo check -p icydb-core --tests` after the executor route narration/stale-comment refresh pass.
- Re-ran `cargo check -p icydb-core --tests` after extracting route contracts into `route::contracts`.
- Re-ran `cargo check -p icydb-core --tests` after moving continuation signature formatting to `db::codec::cursor`.
- Re-ran `cargo check -p icydb-core --tests` and `cargo test -p icydb-core db::executor::tests::route -- --nocapture` after route-contract helper relocation and contracts-surface tightening.
- Re-ran targeted route architecture guards:
  - `db::executor::tests::route::planner_mode::route_planner_remains_decomposed_into_dedicated_submodules`
  - `db::executor::tests::route::planner_capability::route_feature_budget_no_eligibility_helpers_outside_route_module`

---

## 0.34.0 - 2026-02-28 - Commit Narrative Consolidation and No-Shim Recovery

### ðŸ“ Summary

0.34.0 starts the `0.34` clarity/consolidation track with a focused pass over commit execution internals, improving module responsibility narration and phase-level invariant readability while also removing compatibility shims in the commit recovery path.

### ðŸ”§ Changed - Commit Module Narrative

- Added explicit module-boundary responsibility headers in `db::commit::{apply,prepare,replay}` to document semantic ownership and one-way layer dependencies.
- Added phase-level comments in long commit preparation/replay/apply paths to make ordering assumptions and fail-closed behavior explicit at the call-site level.
- Clarified mechanical-apply sequencing intent (`index -> row`) and deterministic replay/rebuild flow, reducing ambiguity for future structural consolidation work.
- Split prepared-op payload ownership into a dedicated `db::commit::prepared_op` module and kept `db::commit::apply` focused on mutation application behavior.
- Split recovery index-rebuild ownership into a dedicated `db::commit::rebuild` module and kept `db::commit::replay` focused on marker row-op replay.
- Extended the same boundary/phase comment pass through `db::commit::{store,memory,rollback}` and removed a one-call recovery marker-clear wrapper in favor of direct `with_commit_store(...).clear_infallible()` at the recovery boundary.

### ðŸ”§ Changed - Compatibility Removal

- Removed the write-only recovery shim (`ensure_recovered_for_write`) and converged call sites on `ensure_recovered`.
- Removed commit-marker schema-fingerprint fallback behavior: replay now requires explicit fingerprint presence and exact match.

### ðŸ”§ Changed - Data Module Narrative

- Added module-boundary responsibility headers across `db::data::{mod,entity_decode,key,row,storage_key,store}` to make ownership and one-way dependency flow explicit.
- Added phase comments to non-trivial key/row encode-decode paths (`DataKey`, `StorageKey`, entity decode helpers) and refreshed stale comment wording to match current control flow.
- Clarified `DataStore` boundary narration as a thin persistence wrapper that assumes prevalidated inputs from higher layers.

### ðŸ”§ Changed - Index Module Narrative

- Added module-boundary responsibility headers across `db::index` and nested key/planning/predicate modules, including `index::key::{codec,ordered}` internals.
- Added phase-level comments in non-trivial index flows (raw key codec encode/decode, index-entry validation, range lowering, store range scan, and index mutation planning).
- Refreshed stale comments to match current control flow and tightened import placement in `index::store` by keeping module imports at top-of-file.
- Split raw-range scan/continuation resolution out of `db::index::store` into a dedicated `db::index::scan` module; `index::store` now owns persistence primitives only.
- Consolidated continuation-envelope helpers (`resume_bounds_from_refs`, `anchor_within_envelope`, `continuation_advanced`) under `db::index::envelope`, removing split authority across `range` and `envelope`.

### ðŸ”§ Changed - Predicate Module Narrative

- Added module-boundary responsibility headers across `db::predicate::{mod,coercion,fingerprint,model,normalize,resolved,row_policy,runtime,schema,semantics}`.
- Added light phase commentary in key compile/evaluation boundaries (`normalize`, `runtime`, and semantic compare helpers) and refreshed stale wording for current control flow.
- Preserved behavior while clarifying ownership boundaries between normalization, validation, runtime execution, and comparison semantics.

### ðŸ”§ Changed - Access Module Narrative

- Added module-boundary responsibility headers across `db::access::{mod,canonical,lowering,path,plan,validate}`.
- Added targeted phase comments for access-plan lowering boundaries and refreshed stale wording, including a small adapter comment typo cleanup.
- Kept access behavior unchanged while making planner/lowering/executor ownership boundaries explicit.
- Moved index-range "not indexable" reason scope/wording mapping into `db::access::lowering`; `db::index::range` now exposes only structural lowering reasons (`IndexRangeBoundEncodeError`).

### ðŸ”§ Changed - Query Module Narrative

- Added module-boundary responsibility headers across `db::query` surfaces touched in this pass, including `builder`, `expr`, `fluent`, `intent`, `plan::group`, `explain`, and `fingerprint`.
- Added phase-level comments in non-trivial query paths (`FilterExpr::lower_with`, key-access lowering in `intent`, grouped handoff projection, explain projection, and fingerprint/signature hashing).
- Refreshed stale/placeholder API doc comments in `query::explain` and `query::fingerprint` to align comments with current semantics and prevent drift.
- Kept query behavior unchanged while tightening ownership narration between intent, planning, explain, and hash surfaces.

### ðŸ”§ Changed - Query Plan Pushdown Modularization

- Extracted secondary ORDER BY pushdown matrix logic from `db::query::plan::mod` into a dedicated `db::query::plan::pushdown` submodule.
- Moved dense pushdown helpers (`match_secondary_order_pushdown_core`, `assess_secondary_order_pushdown_for_plan`, and related applicability derivation) behind that focused module boundary.
- Kept behavior unchanged and preserved existing call surfaces via re-exports from `query::plan`.

### ðŸ”§ Changed - Relation Save Validation Authority

- Moved save-time strong-relation traversal/existence validation out of `executor::mutation::save_validation` into a dedicated `db::relation::save_validate` module.
- Added `relation::validate_save_strong_relations(...)` as the single relation-owned save validation entrypoint and switched executor preflight to delegate to it.
- Kept error classes/messages and runtime behavior unchanged while consolidating relation semantics under `db::relation`.

### ðŸ”§ Changed - Index PK Equivalence Naming

- Renamed `db::index::contracts` to `db::index::pk_equivalence` to make ownership explicit for primary-key equivalence checks used by cursor anchor validation.
- Kept behavior unchanged; this is a naming/authority clarity cleanup only.

### ðŸ”§ Changed - Paged Response Payload Placement

- Moved `PagedLoadExecution` and `PagedLoadExecutionWithTrace` out of `db::mod` into `db::response::paged`.
- Kept caller-facing API stable by re-exporting through `db::response` and the `db` root.
- Kept behavior unchanged; this is a DTO ownership/location cleanup.

### ðŸ”§ Changed - Cursor Plan Surface Refactor

- Added a thin cursor plan-surface contract in `db::cursor::spine` and refactored structured cursor validation to consume that surface instead of threading many independent plan parameters.
- Kept cursor behavior unchanged while reducing parameter fan-out inside the cursor validation pipeline.

### ðŸ§­ Migration Notes

- Internal commit/recovery APIs are intentionally non-backward-compatible in this release (shim paths removed).
- Legacy commit markers without schema fingerprints are no longer replayable.

### ðŸ§ª Testing

- Re-ran `cargo check -p icydb-core` after the commit-module refactors and no-shim compatibility removals.
- Re-ran `cargo check -p icydb-core --tests` after the `db::data` narrative pass.
- Re-ran `cargo check -p icydb-core --tests` after the `db::index` narrative pass.
- Re-ran `cargo check -p icydb-core --tests` after the `db::index::store` / `db::index::scan` split.
- Re-ran `cargo check -p icydb-core --tests` after consolidating continuation-envelope helpers into `db::index::envelope`.
- Re-ran `cargo check -p icydb-core --tests` after the `db::predicate` narrative pass.
- Re-ran `cargo check -p icydb-core --tests` after the `db::access` narrative pass.
- Re-ran `cargo check -p icydb-core --tests` after moving not-indexable reason mapping to `db::access::lowering`.
- Re-ran `cargo check -p icydb-core --tests` after the `db::query` narrative/comment pass.
- Re-ran `cargo check -p icydb-core --tests` after moving save-time strong relation validation into `db::relation::save_validate`.
- Re-ran `cargo check -p icydb-core --tests` after renaming `db::index::contracts` to `db::index::pk_equivalence`.
- Re-ran `cargo check -p icydb-core --tests` after moving paged load response DTOs into `db::response::paged`.
- Re-ran `cargo check -p icydb-core --tests` after the cursor plan-surface refactor in `db::cursor::spine`.
- Re-ran `cargo check -p icydb-core --tests` after extracting query pushdown matrix logic into `db::query::plan::pushdown`.
