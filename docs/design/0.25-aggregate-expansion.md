# 0.25 - Aggregate Expansion Contract

## 1) Decision

`0.25.0` is the first aggregate expansion release.

If a change is internal-only (hardening, cleanup, drift prevention), it remains a `0.24.x` patch.

---

## 2) Why `0.25` Exists

`0.24.x` hardens route/fold foundations so aggregate behavior is stable.

`0.25.0` converts that foundation into user-visible capability:

- more aggregate power for app queries
- predictable fallback behavior when fast paths are ineligible
- a clear path to further aggregate expansion without semantic drift

---

## 3) Release Boundary (Non-Negotiable)

`0.25.0` must include at least one user-visible aggregate capability that was not available in `0.24.x`.

If this condition is not met, the release stays in `0.24.x`.

---

## 4) Scope

### In Scope (`0.25.0`)

- index-aware field extrema support (`min(field)` / `max(field)`) for explicitly eligible shapes
- explicit eligibility boundaries for which field/access combinations can use fast paths
- parity-safe fallback to canonical execution when eligibility is not met
- documentation of supported aggregate/field combinations and known exclusions

### Out of Scope (`0.25.0`)

- cursor model redesign
- planner cost-model redesign
- new continuation envelope formats
- broad DSL expansion unrelated to aggregate capabilities

---

## 5) Semantics Contract

For supported `min(field)` / `max(field)` queries:

- fast path and fallback must produce identical results
- direction semantics are post-order (`ASC`/`DESC` behavior must match normal query execution)
- deterministic tie-break semantics are fixed as `(field_value, primary_key_asc)` for both `ASC` and `DESC`
- DISTINCT/window/cursor semantics must remain aligned with canonical load behavior
- `Strict` and `MissingOk` behavior must stay classification-correct

Unsupported shapes must not silently misbehave:

- either run fallback safely
- or return a typed, clear unsupported error when fallback is intentionally disallowed

### Explicit Terminal Capability Matrix (`0.25`)

| Aggregate terminal | DISTINCT supported | Fast path eligible |
| --- | --- | --- |
| `min_by(field)` | Yes (canonical fallback when fast-path-ineligible) | Yes, route-gated and only for explicitly eligible non-`DISTINCT` shapes |
| `max_by(field)` | Yes (canonical fallback when fast-path-ineligible) | Yes, route-gated and only for explicitly eligible non-`DISTINCT` shapes |
| `nth_by(field, n)` | Yes (canonical fallback path) | No (`0.25` does not add an `nth_by` fast path) |
| `sum_by(field)` | Yes (canonical fallback path) | No (`0.25` does not add `sum_by` fast path) |
| `avg_by(field)` | Yes (canonical fallback path) | No (`0.25` does not add `avg_by` fast path) |
| `median_by(field)` | Yes (canonical fallback path) | No (`0.25` does not add `median_by` fast path) |
| `count_distinct_by(field)` | Yes (canonical fallback path) | No (`0.25` does not add `count_distinct_by` fast path) |
| `min_max_by(field)` | Yes (canonical fallback path) | No (`0.25` does not add `min_max_by` fast path) |

For field extrema, `DISTINCT` is intentionally fast-path ineligible in `0.25` and must route to canonical fallback. For `count_distinct_by`, `DISTINCT` only changes the effective window row set before terminal reduction and does not change field-distinct semantics.

### Continuation Contract (Field Terminals)

| Terminal | Continuation allowed | Behavior |
| --- | --- | --- |
| `min_by` | No | Terminal query only |
| `max_by` | No | Terminal query only |
| `nth_by` | No | Terminal query only |
| `sum_by` | No | Terminal query only |
| `avg_by` | No | Terminal query only |
| `median_by` | No | Terminal query only |
| `count_distinct_by` | No | Terminal query only |
| `min_max_by` | No | Terminal query only |

All field aggregate terminals are non-paged terminal endpoints. Cursor tokens on these terminals must be explicitly rejected (`CursorRequiresPagedExecution`). Continuation remains valid only in paged mode (`.page().execute()`).

### API Examples

```rust
let median_rank_id = session
    .load::<User>()
    .filter_expr(FilterExpr::eq(User::GROUP, 7))?
    .order_by("id")
    .median_by("rank")?;

let distinct_rank_count = session
    .load::<User>()
    .filter_expr(FilterExpr::eq(User::GROUP, 7))?
    .order_by("id")
    .count_distinct_by("rank")?;

let min_max_rank_ids = session
    .load::<User>()
    .filter_expr(FilterExpr::eq(User::GROUP, 7))?
    .order_by("id")
    .min_max_by("rank")?;
```

---

## 6) Eligibility and Routing Contract

Route remains the sole authority for aggregate fast-path eligibility:

- no ad-hoc eligibility branches in executor modules outside route
- no local recomputation of bounded probe hints outside route
- fold behavior is selected by route fold-mode contract, not inferred ad hoc in terminal code

---

## 7) Acceptance Gates (Must Pass Before `0.25.0`)

1. User-visible capability gate:
   - `min(field)` / `max(field)` behavior is available and documented for supported shapes.
2. Parity gate:
   - fast path vs fallback parity across representative shapes.
3. Direction gate:
   - ASC/DESC parity including tie-break behavior where applicable.
4. Window/distinct gate:
   - offset/limit behavior remains aligned with canonical execution, and DISTINCT behavior is explicitly documented per terminal (including fast-path ineligibility cases).
5. Continuation gate:
   - field aggregate terminals explicitly reject continuation (non-paged terminal contract); continuation remains scoped to paged execution only.
6. Consistency gate:
   - `Strict` and `MissingOk` behavior is preserved, including stale-leading index cases.
7. Route stability gate:
   - route matrix tests lock streaming/materialized and fast-path decisions for representative shapes.

---

## 8) Rollout Plan

Phase 1:

- finalize supported field/type shapes for `min(field)` / `max(field)`
- implement route eligibility + fallback guarantees

Phase 2:

- land parity/direction/window/consistency regressions
- lock route matrix expectations for new aggregate shapes

Phase 3:

- document supported capability boundaries
- ship `0.25.0` only if user-visible capability gate is satisfied

---

## 9) Versioning Rule Going Forward

- Internal hardening only: patch releases.
- New user-visible aggregate capability: minor release.
