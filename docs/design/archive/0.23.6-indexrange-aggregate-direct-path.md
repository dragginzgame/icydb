# 0.23.6 - IndexRange Aggregate Direct Path

## 1) Purpose

Ship one focused aggregate optimization in patch scope:

- add a direct aggregate path for `AccessPath::IndexRange`

Target outcomes:

- preserve exact aggregate parity with canonical load execution
- reduce aggregate routing overhead on index-range shapes
- keep executor behavior drift-resistant with explicit invariants

---

## 2) Scope

### In Scope (0.23.6)

- aggregate-aware direct path for `AccessPath::IndexRange`
- invariant checks for spec arity/index alignment
- parity and scan-budget regressions for index-range aggregate shapes

### Out of Scope (0.23.6)

- composite aggregate direct path (`Union` / `Intersection`)
- new aggregate APIs (`sum`, `avg`, value-field aggregates)
- planner/cost-model redesign

---

## 3) Design

Add `try_execute_index_range_aggregate(...)` in aggregate routing.

Rules:

- consume lowered `IndexRangeSpec` only (executor stays byte-level)
- reuse existing index-range traversal functions (no duplicate traversal engine)
- fold through existing shared aggregate fold engine
- bounded probe hints only where safety gates allow

Required invariants:

- exactly one relevant index-range spec for single-path index-range fast path
- spec index must match access-path index
- no semantic `Value` interpretation in this branch

Error/fallback contract:

- unsupported shape or non-applicable conditions: `Ok(None)` and fallback to canonical resolver
- true invariant violation (spec mismatch / impossible internal state): executor invariant error

---

## 4) Semantics Contract

For index-range shapes, fast path must match canonical load semantics exactly:

- `count == execute().count()`
- `exists == !execute().is_empty()`
- `min == execute().ids().min()`
- `max == execute().ids().max()`

Also preserve:

- `Strict` vs `MissingOk` behavior
- `DISTINCT` behavior
- `offset` / `limit` window behavior

---

## 5) Test Plan

Add/extend:

1. IndexRange aggregate parity matrix:
   - asc/desc
   - offset/limit combinations
   - strict/missing-ok consistency
2. Scan-budget checks for safe bounded-probe shapes:
   - `exists`, `min(asc)`, `max(desc)`
3. Invariant tests:
   - missing/spec-arity mismatch
   - spec-index mismatch

Regression gate:

- no existing aggregate parity tests may regress

---

## 6) Rollout

Phase 1:

- implement index-range direct aggregate path behind existing aggregate routing

Phase 2:

- land parity + invariant + scan-budget tests

Phase 3:

- changelog/status alignment for `0.23.6`

---

## 7) Deferred to 0.24+

Composite aggregate direct path is explicitly deferred pending a complexity/benefit audit.

Rationale:

- likely low performance delta versus canonical composite stream resolution
- high risk of duplicated composition logic and ordering drift

