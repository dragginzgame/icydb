# docs/design/0.19-composite-pagination.md

## 1. Purpose

Define **deterministic, duplication-free, omission-free pagination semantics** for
composite execution plans, with explicit cursor continuation behavior.

This milestone freezes the correctness contract for:

* `AccessPath::Union`
* `AccessPath::Intersection`

and their interaction with:

* global ordering (ASC/DESC)
* LIMIT/OFFSET budgeting wrappers (0.18)
* continuation anchors

## Non-goals

0.19 does **not**:

* introduce new storage formats
* introduce binary/opaque cursor encoding
* broaden budget eligibility beyond existing conservative checks
* change predicate semantics / normalization rules
* add cost-based planning

---

## 2. Definitions

### 2.1 Ordered key stream

An `OrderedKeyStream` yields `RawDataKey` values in strict monotonic order under a declared direction:

* ASC: strictly increasing
* DESC: strictly decreasing

### 2.2 Composite plans

A composite plan is defined as one of:

* `Union(Vec<SubPlan>)`
* `Intersection(Vec<SubPlan>)`

Each `SubPlan` must produce an `OrderedKeyStream` over the same entity keyspace.

---

## 3. Global Ordering Contract

### 3.1 Composite ordering

Composite plans must emit keys in the same strict monotonic order as a single stream would:

* Union: ordered merge of substreams with dedupe
* Intersection: ordered alignment of substreams

**Subplan input ordering must not affect output ordering.**

---

## 4. Pagination Contract

### 4.1 Page definition

A “page” is defined over a single canonical phase order:

1. Build the globally ordered composite stream.
2. Apply optional cursor anchor narrowing (`strictly past anchor`).
3. Apply optional offset windowing.
4. Apply limit to produce the page and derive continuation from the last emitted key.

Budgeting (0.18 safe mode) may bound polling work, but does not change this logical phase order.

### 4.2 Continuation anchor

The continuation anchor is:

> the **last emitted** `RawDataKey` of the previous page.

Resume is defined as applying:

* ASC: `Bound::Excluded(anchor)`
* DESC: `Bound::Excluded(anchor)` in the descending comparator space (same conceptual meaning: “strictly past anchor”)

### 4.3 Single-anchor rule

Composite continuation is defined with **one anchor only**.

Per-stream anchors are **not permitted** because they create stateful resume semantics and can reintroduce duplicates/omissions depending on merge state.

---

## 5. Union Semantics

### 5.1 Set semantics

Union yields the set of keys produced by any subplan, deduplicated by key equality.

### 5.2 Streaming merge rule

At every step:

1. Consider the “current head” key from each active substream.
2. Select the next global key according to direction.
3. Emit it.
4. Advance **all** substreams whose head equals the emitted key (dedupe step).
5. Repeat.

### 5.3 Cursor interaction

When resuming from `anchor`, the anchor must be applied to *all* subplans so that:

* no subplan can re-yield `anchor`
* dedupe does not re-emit previously emitted keys

---

## 6. Intersection Semantics

### 6.1 Set semantics

Intersection yields keys present in all subplans.

### 6.2 Streaming alignment rule

Maintain a “current head” for each substream.

Loop:

1. Let `target` be the “greatest” head (ASC) or “smallest” head (DESC) under the active direction.
2. Advance any substream whose head is “behind” `target` until:

   * it reaches `target`, or
   * it exhausts.
3. If all heads equal, emit the key and advance all streams once.

### 6.3 Cursor interaction

On resume, applying `Bound::Excluded(anchor)` to all streams ensures we don’t re-run alignment work on already-emitted candidates.

---

## 7. Correctness Invariants

0.19 must prove these invariants for composite execution:

### 7.1 No duplication across pages

For page `N` and `N+1`:

* `Page(N) ∩ Page(N+1) = ∅`

Especially important for:

* Union with overlap
* Union with overlap at the boundary key (`anchor`)
* Intersection alignment edges

### 7.2 No omission across pages

Let `R` be the full ordered composite result set under the query bounds.
Let `P1..Pk` be emitted pages.

* `⋃ Pi = R`

Clarification:

* This invariant is evaluated under fixed-data/snapshot-style test conditions.
* Under live-state continuation semantics, intervening writes may change future visibility;
  the required guarantee remains strict forward progress from the anchor with no duplicate
  re-emission of already-returned rows.

### 7.3 Stable ordering

Keys emitted are strictly monotonic under direction.
No interleaving nondeterminism due to subplan order or exhaustion timing.

### 7.4 Permutation invariance

Permuting the list of subplans must not change:

* emitted sequence
* page boundaries (given same limit/offset)
* cursor anchor results

---

## 8. Interaction With 0.18 Budgeting

0.18 introduced “budgeted materialization” for safe cases.

0.19 rules:

* Budget wrappers may bound how many keys are *polled*, but must not alter which keys are *eligible* to be emitted given the global ordering semantics.
* Composite pagination correctness must hold whether budgeting is enabled or disabled.

Budgeting must not cause:

* early truncation that changes which key becomes `anchor`
* incomplete dedupe (Union) due to partial polling after emitting a key

Practical constraint:

* If budgeting is applied above a composite stream, it must respect the composite stream’s “advance all equal heads” step (Union) or “advance lagging streams until align” step (Intersection), otherwise the stream’s semantics are broken.
* Budget wrapping is allowed only at the executor stream-consumption boundary:
  `LoadExecutor::materialize_key_stream_into_page`, immediately before
  `Context::rows_from_ordered_key_stream(...)`.

---

## 9. Compatibility and Guardrails

### 9.1 Cursor support status

0.19 decision: **Option A**.

* Composite plans support cursor-enabled continuation using the single-anchor rule.
* Per-stream cursor anchors remain out of scope and prohibited.

---

## 10. Test Matrix

0.19 completion requires tests for:

Each matrix case must run in both `ASC` and `DESC`.

### Union

* disjoint substreams
* overlapping substreams
* one empty substream
* overlap at page boundary (duplicate key equals anchor)
* nested composite union (already partly covered in 0.18; keep it)

### Intersection

* full overlap (identical sets)
* partial overlap
* one stream empty
* “zig-zag” alignment (heads leapfrog)
* alignment at page boundary

### Pagination + cursor

For each scenario above:

* page size 1, 2, and >2
* resume from every page boundary
* assert: no dup / no omission / stable ordering

---

## 11. Completion Criteria

0.19 is complete when:

* Cursor-enabled continuation semantics are either:

  * implemented for composite plans, or
  * explicitly deferred with documented non-goal
* The test matrix passes and is integrated into `executor/tests/pagination.rs`
* Composite plan permutation invariance is covered by at least one test suite
* No additional planner changes are required (only executor/stream correctness)

---

## Summary

0.19 freezes the contract that composite query execution is:

* ordered
* deterministic
* resumable (single anchor)
* free of duplication/omission across pages
